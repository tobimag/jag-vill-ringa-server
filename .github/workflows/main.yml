name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  IMAGE: end-digits-fetcher

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Build project
        run: make build
      - name: Upload jar
        uses: actions/upload-artifact@v2
        with:
          name: Package
          path: build/libs

  build-docker:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download jar
        uses: actions/download-artifact@v2
        with:
          name: Package
      - name: Build docker container
        run: |
          ll
          mkdir -p build/dependency && (cd build/dependency; jar -xf ../*.jar)
          docker build \
            --tag "gcr.io/$PROJECT_ID/$IMAGE:$GITHUB_SHA" \
            --build-arg GITHUB_SHA="$GITHUB_SHA" \
            --build-arg GITHUB_REF="$GITHUB_REF" \